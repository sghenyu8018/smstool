# 更新日志

所有重要的项目变更都将记录在此文件中。

格式基于 [Keep a Changelog](https://keepachangelog.com/zh-CN/1.0.0/)，
并且本项目遵循 [语义化版本](https://semver.org/lang/zh-CN/)。

## [未发布]

### 改进
- **优化资质工单查询：自动设置每页显示100条**
  - 在查询前自动设置分页器为"100 条/页"，减少分页次数
  - 提高查询效率：每页显示更多数据，减少翻页操作
  - 在首次查询和重新查询时都会自动设置
  - 如果设置失败，会继续使用默认设置，不影响查询流程
- **优化资质工单检查逻辑：使用工单号精确查询**
  - 修改检查逻辑：从"重新输入PID查询"改为"输入工单号精确查询"
  - 找到所有包含'短信资质'的工单后，检查每个工单时直接输入工单号查询
  - 提高查询精确度：直接查询工单号，无需遍历所有PID的工单
  - 简化分页查找：精确查询后通常在第一页就能找到，无需分页查找
  - 统一处理逻辑：所有工单都使用相同的查询方式，代码更简洁

### 修复
- **修复资质工单查询中查询按钮点击过于频繁的问题**
  - 问题：查询按钮点击过于频繁导致 OpenSearch 查询失败（retCode: -1）
  - 解决方案：在所有点击查询按钮的地方添加延迟机制
    - 点击前添加 0.5 秒延迟，避免连续点击
    - 点击后等待时间从 2 秒增加到 3 秒，确保查询完成
  - 修复三处位置：首次查询工单号、输入PID后查询、重新查询时
  - 避免请求过于频繁导致的服务器错误
- **修复资质工单查询中工单号查找失败的问题**
  - 问题：返回查询页面后，工单号可能不在第一页，导致查找超时
  - 解决方案：在检查工单时添加分页查找逻辑，自动遍历所有页面查找工单号
  - 如果第一页找不到，自动翻页继续查找，直到找到或遍历完所有页面
  - 提高查询的准确性和成功率
- **优化资质工单查询中分页数据加载等待逻辑**
  - 增加分页切换后的等待时间（从2秒增加到3秒）
  - 添加显式等待表格行加载完成的逻辑，确保数据已渲染
  - 添加每页数据行数的调试信息，便于排查问题
  - 清理冗长的注释，提高代码可读性

### 改进
- **更新 README.md 文档**
  - 添加资质工单查询功能的完整使用示例
  - 在功能特性部分添加资质工单查询说明
  - 在模块说明部分添加 `utils/qualification_query.py` 的详细说明
  - 添加 `query_qualification_work_order` 函数的参数和返回值说明
  - 更新项目结构图，包含资质工单查询模块

### 新增
- **添加测试文件 test/test_local.py**
  - 新增测试定位器功能的测试脚本
  - 支持测试表格行和单元格的提取
  - 使用 Playwright 直接创建浏览器会话，无需登录凭证
  - 可用于测试公开网站的元素定位功能

### 改进
- **优化资质工单查询中PID输入框的查找逻辑**
  - 简化PID输入框选择器逻辑，使用 `wait_for_selector` 替代 `query_selector` + `is_visible` 检查
  - 减少选择器数量，只保留最常用的三个：`#UserId`、`input#UserId`、`input[placeholder="请输入"]`
  - 移除详细的调试信息输出，简化代码
  - 使用 `wait_for_selector` 确保元素可见后再操作，提高稳定性

### 改进
- **优化资质工单查询逻辑：支持遍历所有包含"短信资质"的行（支持分页）**
  - 修改查询逻辑：从只检查第一个"短信资质(智能)"行改为遍历所有包含"短信资质"的行
  - **新增分页支持**：自动遍历所有页面，查找所有包含"短信资质"的行
  - 检查分页器状态：通过检查 `li.ant-pagination-next` 的 `aria-disabled` 属性和 `ant-pagination-disabled` class 判断是否还有下一页
  - 自动点击下一页：如果有下一页，自动点击并等待页面加载，继续查找
  - 去重处理：避免重复添加相同的工单号
  - 依次进入每个工单的详情页面，检查资质组ID是否与关联资质ID匹配
  - 找到匹配的资质ID后立即停止并返回结果
  - 如果所有工单都检查完毕仍未找到匹配的，返回详细的错误信息
  - 每次检查后自动返回查询页面并重新查询，确保能继续检查下一个工单
  - 提高查询的准确性和完整性，避免遗漏匹配的工单

### 修复
- **修复资质工单查询中元素引用失效问题**
  - 修复问题：返回查询页面后，之前保存的元素引用失效导致 `Protocol error (DOM.describeNode)` 错误
  - 解决方案：改为在第一次查找时提取工单号列表（而不是保存元素引用），在每次循环时通过工单号重新查找对应的行
  - 确保每次检查都能正确找到对应的工单，避免因页面重新加载导致的元素引用失效

### 修复
- **修复资质工单查询中可变属性定位问题（完整修复）**
  - 移除对可变属性 `_nk="E7Xi41"` 的依赖，改用直接查找 `pre` 标签
  - 移除对可变属性 `_nk="DYsM21"` 的依赖，改用通用的 `a` 标签选择器
  - 修复三处位置：
    - 获取关联资质ID：使用 `pre` 标签而非 `pre[_nk="E7Xi41"]`
    - 获取资质组ID：使用 `pre` 标签而非 `pre[_nk="E7Xi41"]`
    - 点击工单号链接：使用 `a:has-text()` 和 `td.ant-table-cell a` 而非 `a[_nk="DYsM21"]`
  - 更新 `utils/constants.py` 中的选择器定义，移除所有可变属性依赖
  - 添加备选定位方案：如果找不到 `pre` 标签，尝试从表格行中的 `td` 元素查找包含数字的单元格
  - 提高定位的稳定性和容错性，避免因页面属性变化导致查询失败

### 改进
- **优化表格数据加载等待逻辑，移除无效的等待函数**
  - 移除 `_wait_for_table_ready` 函数及其所有调用（167行代码）
  - 简化等待逻辑：从复杂的检测机制改为简单的3秒等待后直接提取数据
  - 大幅减少等待时间：每次查询从20-30秒减少到3秒，节省约17-27秒
  - 提高查询效率：根据日志分析，表格数据实际上已经加载完成，复杂检测逻辑无法正确识别
  - 简化代码结构，提高可维护性

### 改进
- **启用所有查询功能并集成资质工单查询**
  - 恢复短信签名工单号查询功能
  - 恢复短信签名成功率查询功能（多时间范围）
  - 在主流程中集成资质工单查询功能（工单号查询成功后自动执行）
  - 在查询结果汇总中添加资质工单号信息部分
  - 显示匹配的资质工单号、关联资质ID和资质组ID
  - 完善错误处理，确保所有查询功能正常工作

### 修复
- **修复资质工单查询中PID输入功能异常**
  - 添加 `#UserId` 选择器作为PID输入框的主要选择器（根据实际页面元素）
  - 改进PID输入框查找逻辑，按优先级尝试多个选择器
  - 优化输入流程：先点击获取焦点，清空现有内容，再填写新值，最后验证输入结果
  - 增强错误处理：当找不到输入框时，列出页面上的所有输入框以便调试
  - 解决PID输入框无法找到或填写失败的问题

### 新增
- **资质工单查询功能**
  - 新增 `query_qualification_work_order` 函数，支持查询资质工单
  - 实现完整的查询流程：输入工单号查询、获取关联资质ID、输入PID查询、找到短信资质行、获取资质组ID并比较
  - 支持通过工单号和PID查询匹配的资质工单
  - 返回匹配的工单号、关联资质ID和资质组ID
  - 添加资质工单查询相关的URL和选择器配置

### 修复
- **修复工单号查询功能：优先使用第十列工单号，第一列作为备选**
  - 优先从第十列提取主要工单号
  - 当第十列不存在或没有工单号时，使用第一列作为备选工单号
  - 在日志中显示工单号的来源（第十列或第一列），便于调试
  - 确保工单号提取逻辑的准确性
- **修复工单号查询功能：添加签名名称完全匹配**
  - 在提取表格数据时，同时提取第二列的签名名称
  - 对签名名称进行完全匹配验证，只保留匹配的行数据
  - 从 `div.break-all` 中提取签名名称，自动去除复制按钮图标等干扰元素
  - 解决查询到多行或单行数据时，可能返回不匹配签名名称的工单号的问题
  - 在输出中显示签名匹配状态，便于调试

### 改进
- **添加查询结果汇总输出（美化）**
  - 在最后输出中，同时显示工单号和成功率数据汇总
  - 工单号信息包括：最新工单号、总数、前3个工单号列表
  - 成功率数据汇总采用完整表格格式，包含：签名、成功率、短信类型、提交量
  - 表格格式美化：对齐整齐，列宽统一，数据格式统一（成功率无%符号，提交量无千位分隔符）
  - 即使部分查询失败，也会显示成功查询的结果
- **优化表格数据加载等待逻辑**
  - 如果表格有足够的数据行（超过5行），即使没有在前10行找到PID，也认为表格已加载完成
  - 解决等待超时但实际数据已加载完成的问题，减少不必要的等待时间
  - 优化等待提示信息，更准确地反映表格加载状态
- **优化滚动提示信息**
  - 如果页面不需要滚动（内容高度很小），给出更友好的提示信息
  - 区分"已滚动到底部"和"页面内容已完全可见"两种情况
- **静默处理单元格数量不足的行**
  - 单元格数量不足的行可能是表头行或特殊行，不再显示警告信息
  - 减少日志噪音，提高日志可读性

### 修复
- **统一多时间范围查询的数据提取逻辑**
  - 将 `_select_time_range_only` 函数的数据提取逻辑与 `query_sms_success_rate` 完全统一
  - 两个函数都使用通用选择器直接查找表格行，不再依赖容器查找
  - 统一数据提取逻辑，确保提取完整的11个字段
  - 统一表头过滤、PID匹配和错误处理逻辑
  - 解决后续查询失败的问题，确保所有时间范围的查询都能成功
- **修复切换时间范围后找不到表格的问题**
  - 切换时间范围后，SLS iframe可能被重新加载，导致旧的iframe引用失效
  - 在切换时间范围后重新获取SLS iframe引用，并等待iframe重新加载完成
  - 在等待数据加载的循环中，每次重试前都重新获取iframe引用，确保引用有效
  - 增加等待次数（从20次增加到30次），确保有足够时间等待数据加载
  - 解决第二次及后续查询时找不到"客户签名视角 -剔除重试过程"表格的问题
- **修复多时间范围查询结果访问时的 KeyError 问题**
  - 在访问 `multi_result['results'][time_range]` 前添加键存在性检查
  - 当首次查询失败时，避免因访问不存在的键而导致程序崩溃
  - 改进错误提示，当某个时间范围的查询结果不存在时，显示友好的错误信息
  - 解决首次查询失败后访问后续时间范围结果时出现的 `KeyError: '一周'` 错误

### 新增
- **窗口尺寸测试脚本**
  - 新增 `test_viewport_sizes.py` 测试脚本，用于测试不同窗口尺寸下成功率查询页面的显示效果
  - 支持测试 7 种常见窗口尺寸（从 1920x1080 到 800x600）
  - 自动检查页面元素、iframe 和关键功能
  - 自动保存全页面截图，便于对比不同尺寸下的显示效果
  - 支持测试菜单点击功能（如果设置了 PID）
- **多时间范围成功率查询功能**
  - 实现默认查询多个时间范围的成功率（当天、一周、本周、30天）
  - 新增 `query_sms_success_rate_multi` 函数，支持一次性查询多个时间范围
  - 优化输出格式，按时间范围分组显示：签名、成功率、短信类型、提交量

### 改进
- **代码重构：提取iframe相关辅助函数（第四阶段）**
  - 创建 `_find_sls_iframe` 辅助函数，统一查找SLS iframe逻辑
  - 创建 `_scroll_to_bottom` 辅助函数，统一滚动页面到底部逻辑
  - 创建 `_wait_for_iframe_load` 辅助函数，统一等待iframe加载完成逻辑
  - 消除多处重复的iframe查找和等待代码
  - 提高代码可维护性和可读性
  - 减少代码行数约50行（从约1170行减少到约1120行）
- **代码重构：提取时间范围选择函数（第三阶段）**
  - 创建 `_select_time_range` 辅助函数，统一时间范围选择逻辑
  - 消除 `_select_time_range_only` 和 `query_sms_success_rate` 中约120行重复代码
  - 支持通过参数控制是否重新获取iframe引用（适应不同场景）
  - 统一时间范围映射，提高代码可维护性和可读性
  - 减少代码行数约120行（从约1290行减少到约1170行）
- **代码重构：提取等待表格加载函数（第二阶段）**
  - 创建 `_wait_for_table_ready` 辅助函数，统一等待表格加载逻辑
  - 消除 `_select_time_range_only` 和 `query_sms_success_rate` 中约100行重复代码
  - 支持通过参数控制是否重新获取iframe引用（适应不同场景）
  - 提高代码可维护性和可读性
  - 减少代码行数约100行（从约1390行减少到约1290行）
- **代码重构：提取数据提取函数（第一阶段）**
  - 创建 `_extract_table_data` 辅助函数，统一数据提取逻辑
  - 消除 `_select_time_range_only` 和 `query_sms_success_rate` 中约200行重复代码
  - 提高代码可维护性和可读性
  - 减少代码行数约200行（从1590行减少到约1390行）
- **增强页面滚动功能**
  - 改进滚动逻辑，使用多种方法确保滚动成功（滚动到底部、滚动到表格元素、再次滚动到底部）
  - 验证滚动位置，确认滚动是否成功
  - 在等待数据加载的循环中，每5次重试滚动一次，触发懒加载确保表格内容完全渲染
  - 增加等待时间，确保滚动后内容完全渲染
- **简化表格查找逻辑**
  - 找到标题元素后，直接使用通用选择器查找表格行，不再查找容器
  - 简化代码逻辑，提高查找效率
  - 保留备用查找逻辑，确保在异常情况下仍能查找表格
- **优化表格加载完成判断逻辑**
  - 通过检查表格内容中是否包含PID来判断表格是否真正加载完成
  - 如果提供了PID且在表格前10行中找到匹配的PID，则认为表格已加载完成
  - 避免在数据未完全加载时就尝试提取数据，提高查询的准确性和稳定性
- **增强时间范围切换后的页面操作**
  - 在切换时间范围后，自动滚动页面到底部，确保表格内容完全可见
  - 与第一次查询保持一致的用户体验
- **优化代码和日志输出**
  - 注释掉步骤6的调试代码（打印SLS iframe中的所有元素），减少不必要的日志输出
  - 保留代码结构，便于后续需要时恢复调试功能
- **优化多时间范围查询流程**
  - 明确第二次及后续查询从"按回车键触发搜索/选择"之后的流程开始
  - 第二次查询跳过输入PID和按回车键步骤，直接从选择时间范围开始
  - 更新函数注释，明确说明流程起点
- **简化表格查找逻辑**
  - 直接使用 `sls_frame.locator('span.chartPanel-m__text__e25a6898:has-text("客户签名视角 -剔除重试过程")')` 定位器查找表格
  - 删除备用查找方法，简化代码逻辑
  - 优化等待表格数据加载的逻辑，使用定位器直接查找表格行
- **增强时间范围选择功能**
  - 选择时间范围后自动滚动页面到底部，确保表格内容完全可见
  - 添加滚动操作的错误处理
- **增强时间范围选择调试功能**
  - 在查找时间范围选项之前，先打印所有可用的时间范围选项
  - 显示每个选项的文本、可见性和class属性，便于调试和确认页面选项
  - 帮助快速定位时间范围选择问题
- **优化多时间范围查询流程**
  - 首次查询时输入PID，后续查询只需切换时间范围，无需重新输入PID
  - 提升查询效率，减少重复操作
  - 新增 `skip_pid_input` 参数，支持跳过PID输入步骤
- **增强浏览器窗口尺寸配置**
  - 在 `create_playwright_session` 函数中添加 `viewport` 参数，支持自定义窗口尺寸
  - 在 `sms_signature_query.py` 中明确设置窗口尺寸为 1280×1100
  - 保持向后兼容，默认尺寸仍为 1280×1100
- **增强日志记录功能**
  - 在 SLS iframe 元素日志中记录表格行和表格单元格的具体内容
  - 支持记录最多50行表格行内容和100个单元格内容
  - 在控制台输出前10行和前20个单元格的详细信息，便于实时查看

### 修复
- 修复成功率查询中 `Locator` 对象使用 `query_selector_all()` 方法的错误
  - 将 `locator().all()` 返回的 `Locator` 对象转换为 `ElementHandle` 对象
  - 确保表格行和单元格提取使用正确的 API
- 优化"客户签名视角"表格数据提取逻辑
  - 添加表头行过滤，自动跳过包含"pid"、"signname"等表头文本的行
  - 确保正确提取 signname（第2个单元格）和回执成功率（第8个单元格）
  - 改进调试输出，明确显示关键字段的提取结果
- **修复SLS iframe加载等待问题**
  - 改进iframe加载等待逻辑，确保页面完全加载后再查找元素
  - 添加多阶段等待：DOM加载 → 资源加载 → 关键元素出现
  - 增加重试机制（最多10次），每次间隔1秒
  - 检查输入框、筛选条件等关键元素是否已出现
  - 解决"页面未加载完毕程序就停止"的问题
- **修复表格数据加载等待问题**
  - 在填写PID并选择时间范围后，添加表格数据加载等待逻辑
  - 等待"客户签名视角 -剔除重试过程"表格的数据行出现
  - 最多等待60秒（30次重试，每次2秒），确保表格数据完全加载
  - 检查表格容器和数据行数量，确保数据已渲染完成
  - 解决"未找到目标表格容器"的问题
- **修复成功率数据过滤问题**
  - 添加PID匹配过滤逻辑，只返回与输入PID匹配的数据
  - 优先使用PID匹配的数据计算成功率
  - 如果没有匹配的数据，才使用所有数据
  - 在日志中明确标记PID匹配和不匹配的数据行
  - 解决返回错误成功率（返回了其他PID的数据）的问题
- **优化等待和查找逻辑**
  - 优化表格数据加载等待：减少等待间隔（2秒→1秒），减少最大等待时间（60秒→20秒）
  - 更早检测到数据已加载，立即退出等待循环
  - 方式1成功后跳过方式2，避免不必要的查找
  - 改进进度输出，每3次打印一次（原每5次）
  - 减少额外等待时间（2秒→1秒）
- **添加日志记录功能**
  - 将步骤6（打印SLS iframe元素）的输出内容保存到日志文件
  - 日志文件保存在 `logs/` 目录，文件名包含时间戳
  - 日志包含查询条件、输入框、表格行和单元格等详细信息
  - 便于后续分析和调试
- **创建日志模块**
  - 新增 `utils/logger.py` 模块，提供统一的日志记录功能
  - 使用 Python 标准 `logging` 模块
  - 支持控制台和文件双重输出
  - 提供专门的 `log_iframe_elements` 方法记录SLS iframe元素
  - 日志文件按日期命名，支持追加模式
  - 可在其他模块中复用日志功能
- **改进成功率查询结果显示**
  - 在打印结果中增加"短信类型"和"提交量"字段
  - 显示更完整的数据信息，便于查看和分析

### 新增
- 添加短信签名成功率查询功能 (`query_sms_success_rate`)
  - 支持查询指定PID的短信签名成功率
  - 支持多个时间范围：当天、本周、一周、上周、30天
  - 返回详细的统计数据，包括"客户签名视角"表格的所有字段

### 改进
- 短信签名查询支持多行工单号提取
- 根据修改时间自动选择最新的工单号
- 支持从环境变量读取PID和签名名称
- 成功率查询优化：直接在SLS iframe (Frame 3)中操作，提高效率和稳定性
- 成功率查询时间选择器改为30天
- 添加详细的元素打印功能，便于调试和判断查询条件
- 设置浏览器窗口尺寸为 1280x1100，优化显示效果
- **成功率查询功能增强**：
  - 支持多个时间范围选择（当天、本周、一周、上周、30天）
  - **精确定位"客户签名视角 -剔除重试过程"表格**，确保提取正确的数据
  - 完整提取"客户签名视角"表格数据，包括：
    - signname（签名名称）
    - 短信类型
    - 提交量
    - 回执量
    - 回执成功率
    - 回执率、十秒回执率、三十秒回执率、六十秒回执率等完整统计信息
  - 改进数据提取逻辑，优先从 `table-m__split-container` 容器中提取数据

### 重构
- **代码模块化**: 将查询函数拆分到独立的工具模块
  - 创建 `utils/sms_query_tools.py` 模块，包含所有查询核心功能
  - 创建 `utils/__init__.py`，提供统一的导入接口
  - 简化 `sms_signature_query.py`，仅保留导入、扩展基类和主入口
  - 提高代码模块化和可维护性
  - 保持向后兼容性
- **进一步模块化拆分**：将 `utils/sms_query_tools.py` 拆分为多个模块，提高可读性和可维护性
  - `utils/constants.py`: 常量和选择器配置
  - `utils/helpers.py`: 辅助函数（工单号提取、日期解析、单元格文本提取）
  - `utils/sms_signature_query.py`: 短信签名查询功能
  - `utils/sms_success_rate_query.py`: 短信签名成功率查询功能
  - `utils/sms_query_tools.py`: 保留作为向后兼容层
  - 每个模块职责单一，代码更易读和维护

### 文档
- 添加 `.cursorrules` 文件，定义代码提交规范
  - 要求提交前必须更新 CHANGELOG.md 和 README.md
- 更新 `.gitignore`，排除 `.cursor/` 目录，避免提交 IDE 配置
  - 提供提交信息格式指南
  - 包含文档更新示例和检查清单

## [1.0.0] - 2024

### 新增
- 初始版本发布
- 短信签名查询功能 (`query_sms_signature`)
  - 支持根据客户PID和签名名称查询工单号
  - 支持多行工单号查询，自动选择最新的
- SSO自动登录功能
- 会话管理功能（24小时有效期）
- 环境变量配置支持
- 完整的项目文档

### 技术栈
- Playwright - 浏览器自动化
- Python 3.8+ - 编程语言
- asyncio - 异步编程支持
