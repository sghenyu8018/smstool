# 更新日志

所有重要的项目变更都将记录在此文件中。

格式基于 [Keep a Changelog](https://keepachangelog.com/zh-CN/1.0.0/)，
并且本项目遵循 [语义化版本](https://semver.org/lang/zh-CN/)。

## [未发布]

### 修复
- 修复成功率查询中 `Locator` 对象使用 `query_selector_all()` 方法的错误
  - 将 `locator().all()` 返回的 `Locator` 对象转换为 `ElementHandle` 对象
  - 确保表格行和单元格提取使用正确的 API
- 优化"客户签名视角"表格数据提取逻辑
  - 添加表头行过滤，自动跳过包含"pid"、"signname"等表头文本的行
  - 确保正确提取 signname（第2个单元格）和回执成功率（第8个单元格）
  - 改进调试输出，明确显示关键字段的提取结果
- **修复SLS iframe加载等待问题**
  - 改进iframe加载等待逻辑，确保页面完全加载后再查找元素
  - 添加多阶段等待：DOM加载 → 资源加载 → 关键元素出现
  - 增加重试机制（最多10次），每次间隔1秒
  - 检查输入框、筛选条件等关键元素是否已出现
  - 解决"页面未加载完毕程序就停止"的问题
- **修复表格数据加载等待问题**
  - 在填写PID并选择时间范围后，添加表格数据加载等待逻辑
  - 等待"客户签名视角 -剔除重试过程"表格的数据行出现
  - 最多等待60秒（30次重试，每次2秒），确保表格数据完全加载
  - 检查表格容器和数据行数量，确保数据已渲染完成
  - 解决"未找到目标表格容器"的问题
- **修复成功率数据过滤问题**
  - 添加PID匹配过滤逻辑，只返回与输入PID匹配的数据
  - 优先使用PID匹配的数据计算成功率
  - 如果没有匹配的数据，才使用所有数据
  - 在日志中明确标记PID匹配和不匹配的数据行
  - 解决返回错误成功率（返回了其他PID的数据）的问题
- **优化等待和查找逻辑**
  - 优化表格数据加载等待：减少等待间隔（2秒→1秒），减少最大等待时间（60秒→20秒）
  - 更早检测到数据已加载，立即退出等待循环
  - 方式1成功后跳过方式2，避免不必要的查找
  - 改进进度输出，每3次打印一次（原每5次）
  - 减少额外等待时间（2秒→1秒）
- **添加日志记录功能**
  - 将步骤6（打印SLS iframe元素）的输出内容保存到日志文件
  - 日志文件保存在 `logs/` 目录，文件名包含时间戳
  - 日志包含查询条件、输入框、表格行和单元格等详细信息
  - 便于后续分析和调试
- **创建日志模块**
  - 新增 `utils/logger.py` 模块，提供统一的日志记录功能
  - 使用 Python 标准 `logging` 模块
  - 支持控制台和文件双重输出
  - 提供专门的 `log_iframe_elements` 方法记录SLS iframe元素
  - 日志文件按日期命名，支持追加模式
  - 可在其他模块中复用日志功能

### 新增
- 添加短信签名成功率查询功能 (`query_sms_success_rate`)
  - 支持查询指定PID的短信签名成功率
  - 支持多个时间范围：当天、本周、一周、上周、30天
  - 返回详细的统计数据，包括"客户签名视角"表格的所有字段

### 改进
- 短信签名查询支持多行工单号提取
- 根据修改时间自动选择最新的工单号
- 支持从环境变量读取PID和签名名称
- 成功率查询优化：直接在SLS iframe (Frame 3)中操作，提高效率和稳定性
- 成功率查询时间选择器改为30天
- 添加详细的元素打印功能，便于调试和判断查询条件
- 设置浏览器窗口尺寸为 1280x1100，优化显示效果
- **成功率查询功能增强**：
  - 支持多个时间范围选择（当天、本周、一周、上周、30天）
  - **精确定位"客户签名视角 -剔除重试过程"表格**，确保提取正确的数据
  - 完整提取"客户签名视角"表格数据，包括：
    - signname（签名名称）
    - 短信类型
    - 提交量
    - 回执量
    - 回执成功率
    - 回执率、十秒回执率、三十秒回执率、六十秒回执率等完整统计信息
  - 改进数据提取逻辑，优先从 `table-m__split-container` 容器中提取数据

### 重构
- **代码模块化**: 将查询函数拆分到独立的工具模块
  - 创建 `utils/sms_query_tools.py` 模块，包含所有查询核心功能
  - 创建 `utils/__init__.py`，提供统一的导入接口
  - 简化 `sms_signature_query.py`，仅保留导入、扩展基类和主入口
  - 提高代码模块化和可维护性
  - 保持向后兼容性
- **进一步模块化拆分**：将 `utils/sms_query_tools.py` 拆分为多个模块，提高可读性和可维护性
  - `utils/constants.py`: 常量和选择器配置
  - `utils/helpers.py`: 辅助函数（工单号提取、日期解析、单元格文本提取）
  - `utils/sms_signature_query.py`: 短信签名查询功能
  - `utils/sms_success_rate_query.py`: 短信签名成功率查询功能
  - `utils/sms_query_tools.py`: 保留作为向后兼容层
  - 每个模块职责单一，代码更易读和维护

### 文档
- 添加 `.cursorrules` 文件，定义代码提交规范
  - 要求提交前必须更新 CHANGELOG.md 和 README.md
- 更新 `.gitignore`，排除 `.cursor/` 目录，避免提交 IDE 配置
  - 提供提交信息格式指南
  - 包含文档更新示例和检查清单

## [1.0.0] - 2024

### 新增
- 初始版本发布
- 短信签名查询功能 (`query_sms_signature`)
  - 支持根据客户PID和签名名称查询工单号
  - 支持多行工单号查询，自动选择最新的
- SSO自动登录功能
- 会话管理功能（24小时有效期）
- 环境变量配置支持
- 完整的项目文档

### 技术栈
- Playwright - 浏览器自动化
- Python 3.8+ - 编程语言
- asyncio - 异步编程支持
